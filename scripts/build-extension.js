#!/usr/bin/env node
// build-extension.js — Generate browser-compatible files from shared modules
//
// Run from repo root:  node scripts/build-extension.js
//
// Generates:
//   packages/extension/patterns.js      (window.SAFEPASTE_PATTERNS)
//   packages/extension/detect-core.js   (window.SafePasteCore)

const fs = require("fs");
const path = require("path");

const SHARED = path.join(__dirname, "..", "packages", "shared");
const EXT = path.join(__dirname, "..", "packages", "extension");

// ---------------------------------------------------------------------------
// 1. Generate patterns.js for the extension
// ---------------------------------------------------------------------------
const patterns = require(path.join(SHARED, "patterns.js"));

function serializePattern(p) {
  const lines = [];
  lines.push(`    id: ${JSON.stringify(p.id)}`);
  lines.push(`    weight: ${p.weight}`);
  lines.push(`    category: ${JSON.stringify(p.category)}`);
  lines.push(`    match: ${p.match.toString()}`);
  lines.push(`    explanation: ${JSON.stringify(p.explanation)}`);
  return `  {\n${lines.join(",\n")}\n  }`;
}

const patternsSource = [
  "// patterns.js — GENERATED by scripts/build-extension.js",
  "// Do not edit directly. Edit packages/shared/patterns.js instead.",
  "//",
  `// Generated: ${new Date().toISOString()}`,
  "",
  "window.SAFEPASTE_PATTERNS = [",
  "",
  patterns.map(serializePattern).join(",\n\n"),
  "",
  "];",
  ""
].join("\n");

fs.writeFileSync(path.join(EXT, "patterns.js"), patternsSource, "utf8");
console.log("  ✓ packages/extension/patterns.js");

// ---------------------------------------------------------------------------
// 2. Generate detect-core.js for the extension
// ---------------------------------------------------------------------------
// Read the shared detect.js source and wrap it in an IIFE that exposes
// the functions on window.SafePasteCore.

const detectSource = fs.readFileSync(path.join(SHARED, "detect.js"), "utf8");

// Strip the leading comment block, the module.exports, and the trailing newline.
// We'll add our own wrapper.
const strippedDetect = detectSource
  // Remove everything up to and including the first blank line after comments
  .replace(/^\/\/.*\n(\/\/.*\n)*\n/, "")
  // Remove module.exports block at the end
  .replace(/\nmodule\.exports\s*=\s*\{[\s\S]*?\};\s*$/, "");

const detectCoreSource = [
  "// detect-core.js — GENERATED by scripts/build-extension.js",
  "// Do not edit directly. Edit packages/shared/detect.js instead.",
  "//",
  `// Generated: ${new Date().toISOString()}`,
  "",
  "(function () {",
  '  "use strict";',
  "",
  strippedDetect,
  "",
  "  window.SafePasteCore = {",
  "    normalizeText: normalizeText,",
  "    findMatches: findMatches,",
  "    computeScore: computeScore,",
  "    riskLevel: riskLevel,",
  "    looksLikeOCR: looksLikeOCR,",
  "    isBenignContext: isBenignContext,",
  "    hasExfiltrationMatch: hasExfiltrationMatch,",
  "    applyDampening: applyDampening",
  "  };",
  "})();",
  ""
].join("\n");

fs.writeFileSync(path.join(EXT, "detect-core.js"), detectCoreSource, "utf8");
console.log("  ✓ packages/extension/detect-core.js");

console.log("\nDone. Remember to update manifest.json if detect-core.js is new.");
